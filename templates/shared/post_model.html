<div x-show="isPostModalOpen" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="p-6 bg-white rounded-lg shadow-lg w-96">
        <h2 class="mb-4 text-xl font-bold">æ–°å¢è²¼æ–‡</h2>
        <form @submit.prevent="submitPost">
            {% csrf_token %}
            <label class="block mb-2">å…§å®¹ï¼š</label>
            <textarea x-model="postContent" class="w-full px-3 py-2 mb-3 border rounded-md" required></textarea>
            <label class="block mb-2">åœ–ç‰‡ï¼š</label>
            <input type="file" @change="handleFileUpload" class="mb-3">
            <div class="flex justify-end">
                <button type="button" @click="isPostModalOpen = false" class="px-4 py-2 mr-2 text-gray-600 bg-gray-300 rounded-lg">å–æ¶ˆ</button>
                <button type="submit" class="px-4 py-2 text-white bg-blue-500 rounded-lg">ç™¼å¸ƒ</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("postModal", () => ({
            isPostModalOpen: false,
            postContent: "",
            imageFile: null,

            handleFileUpload(event) {
                this.imageFile = event.target.files[0];
            },

            async submitPost() {
                if (!this.postContent.trim()) {
                    alert("å…§å®¹ä¸å¯ç‚ºç©ºï¼");
                    return;
                }

                let formData = new FormData();
                formData.append("title", "New Post");  // ğŸ”¥ ä¿®æ­£ï¼šDjango éœ€è¦ `title`
                formData.append("content", this.postContent);
                if (this.imageFile) {
                    formData.append("image", this.imageFile);
                }

                // ğŸ”¥ ç¢ºä¿ CSRF Token æ­£ç¢ºå‚³é
                let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

                try {
                    const response = await fetch("/posts/new/", {  // ğŸ”¥ ä¿®æ­£ URL ç¢ºä¿æ­£ç¢º
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                        },
                        body: formData,
                    });

                    if (response.ok) {
                        location.reload();
                    } else {
                        let data = await response.json();
                        alert("ç™¼æ–‡å¤±æ•—ï¼š" + (data.error || "è«‹é‡è©¦"));
                    }
                } catch (error) {
                    console.error("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                    alert("ç™¼æ–‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼");
                }
            },
        }));
    });
</script>
