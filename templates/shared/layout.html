<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PicTrace</title>
    {% load static %}
    <link href="{% static 'css/tailwind.css' %}" rel="stylesheet" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body class="flex flex-col min-h-screen" x-data="postModal()">
    {% include "shared/navbar.html" %}

    <main class="flex flex-col flex-grow">
      {% block content %}{% endblock %}
    </main>

    {% include "shared/footer.html" %}

    <!-- 發文 Modal (全域可用) -->
    <div x-show="isPostModalOpen" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
      <div class="p-6 bg-white rounded-lg shadow-lg w-96">
        <h2 class="mb-4 text-xl font-bold">新增貼文</h2>
        <form @submit.prevent="submitPost">
          <label class="block mb-2">標題：</label>
          <input type="text" x-model="postTitle" class="w-full px-3 py-2 mb-3 border rounded-md" required>

          <label class="block mb-2">內容：</label>
          <textarea x-model="postContent" class="w-full px-3 py-2 mb-3 border rounded-md" required></textarea>

          <label class="block mb-2">圖片：</label>
          <input type="file" @change="handleFileUpload" class="mb-3">

          <div class="flex justify-end">
            <button type="button" @click="isPostModalOpen = false" class="px-4 py-2 mr-2 text-gray-600 bg-gray-300 rounded-lg">
              取消
            </button>
            <button type="submit" class="px-4 py-2 text-white bg-blue-500 rounded-lg">發布</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("alpine:init", () => {
          Alpine.data("postModal", () => ({
              isPostModalOpen: false,
              postTitle: "",
              postContent: "",
              imageFile: null,

              handleFileUpload(event) {
                  this.imageFile = event.target.files[0];
              },

              async submitPost() {
                  if (!this.postTitle || !this.postContent) {
                      alert("標題和內容不可為空！");
                      return;
                  }

                  let formData = new FormData();
                  formData.append("title", this.postTitle);
                  formData.append("content", this.postContent);
                  if (this.imageFile) {
                      formData.append("image", this.imageFile);
                  }

                  try {
                      const response = await fetch("{% url 'posts:create_post' %}", {
                          method: "POST",
                          headers: {
                              "X-CSRFToken": "{{ csrf_token }}"
                          },
                          body: formData
                      });

                      if (response.ok) {
                          location.reload();
                      } else {
                          alert("發文失敗，請重試");
                      }
                  } catch (error) {
                      console.error("發生錯誤：", error);
                      alert("發文時發生錯誤！");
                  }
              }
          }));
      });
    </script>
  </body>
</html>
