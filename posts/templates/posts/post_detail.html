{% extends "shared/layout.html" %} {% load static %} {% block content %}

<!-- å°‡ x-data æåˆ°æœ€å¤–å±¤ -->
<div
  x-data="{ liked: {{ user_has_liked|yesno:'true,false' }}, likeCount: {{ post.like_count }}, commentCount: {{ comments|length }}, commentModal: false }"
>
  <div class="max-w-3xl p-6 mx-auto mt-10 bg-white rounded-lg shadow-lg">
    {% if post.image_url %}
    <img
      src="{{ post.image_url }}"
      alt="Post Image"
      class="w-full mb-4 rounded-md"
    />
    {% endif %}

    <h2 class="mb-2 text-2xl font-bold">{{ post.author.username }} çš„è²¼æ–‡</h2>
    <p class="mb-4 text-gray-600">{{ post.content }}</p>

    {% if post.location %}
    <p class="mb-2 text-gray-500">ğŸ“ {{ post.location }}</p>
    {% endif %}

    <p class="text-sm text-gray-400">
      ç™¼å¸ƒæ–¼ {{ post.created_at|date:"Y-m-d H:i" }}
    </p>

    <!-- â¤ï¸ æ„›å¿ƒæŒ‰éˆ• å’Œ ğŸ’¬ ç•™è¨€æŒ‰éˆ• -->
    <div class="flex items-center mt-4 space-x-4">
      <!-- æ„›å¿ƒæŒ‰éˆ• -->
      <button
        @click.stop.prevent="toggleLike({{ post.id }})"
        :class="liked ? 'text-red-500' : 'text-gray-500'"
        class="flex items-center space-x-1 focus:outline-none group"
        data-post-id="{{ post.id }}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6 transition-transform duration-200 group-hover:scale-110"
          :fill="liked ? 'currentColor' : 'none'"
          viewBox="0 0 20 20"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
          />
        </svg>
        <span x-text="likeCount"></span>
      </button>

      <!-- ğŸ’¬ ç•™è¨€æŒ‰éˆ• -->
      <button
        @click="commentModal = true"
        class="flex items-center space-x-1 text-gray-500 focus:outline-none group"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6 transition-transform duration-200 group-hover:scale-110"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8 10h8M8 14h4m-6 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12l4-4z"
          />
        </svg>
        <span x-text="commentCount"></span>
      </button>
    </div>

    <!-- ğŸ’¬ ç•™è¨€å€åŸŸ -->
    <div class="mt-6">
      <h3 class="mb-4 text-xl font-bold">ç•™è¨€</h3>

      <!-- ç•™è¨€è¡¨å–® -->
      {% if user.is_authenticated %}
      <form
        id="commentForm"
        method="post"
        action="{% url 'posts:add_comment' post.id %}"
        class="mb-6"
      >
        {% csrf_token %}
        <textarea
          id="commentContent"
          name="content"
          rows="3"
          placeholder="æ’°å¯«ç•™è¨€..."
          class="w-full p-2 border rounded-lg focus:outline-none focus:ring"
          required
        ></textarea>
        <button
          type="submit"
          class="px-4 py-2 mt-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600"
        >
          ç™¼ä½ˆç•™è¨€
        </button>
      </form>
      {% else %}
      <p class="mt-4 text-gray-600">
        <a href="{% url 'account_login' %}" class="text-blue-500">ç™»å…¥</a>
        ä»¥ç•™è¨€ã€‚
      </p>
      {% endif %}

      <!-- ç•™è¨€åˆ—è¡¨ -->
      <div class="space-y-4" id="commentsList">
        {% for comment in comments %}
        <div
          class="relative p-4 bg-gray-100 rounded-lg"
          x-data="{ isEditing: false, showMenu: false, editContent: '{{ comment.content|escapejs }}' }"
        >
          <!-- ç•™è¨€è€…åç¨± -->
          <p class="font-semibold">{{ comment.author.username }}</p>

          <!-- é¡¯ç¤ºæ¨¡å¼ -->
          <p x-show="!isEditing" class="text-gray-700" x-text="editContent"></p>

          <!-- ç·¨è¼¯æ¨¡å¼ -->
          <div x-show="isEditing" class="mt-2">
            <textarea
              x-model="editContent"
              rows="2"
              class="w-full p-2 border rounded-md"
            ></textarea>
            <div class="flex justify-end mt-2">
              <button
                @click="isEditing = false"
                class="px-3 py-1 mr-2 bg-gray-300 rounded-lg"
              >
                å–æ¶ˆ
              </button>
              <button
                @click="updateComment($el.getAttribute('data-comment-id'), editContent)"
                class="px-3 py-1 text-white bg-blue-500 rounded-lg"
                data-comment-id="{{ comment.id }}"
              >
                æ›´æ–°
              </button>
            </div>
          </div>

          <!-- ç•™è¨€æ™‚é–“ -->
          <p class="text-sm text-gray-500">
            {{ comment.created_at|timesince }} å‰
          </p>

          <!-- ã€Œâ‹¯ã€é¸å–®æŒ‰éˆ•ï¼ˆåªæœ‰ç•™è¨€è€…å¯è¦‹ï¼‰ -->
          {% if user == comment.author %}
          <div class="absolute top-2 right-2">
            <button
              @click="showMenu = !showMenu"
              class="p-2 text-gray-500 rounded-full hover:text-gray-700 hover:bg-gray-200"
            >
              â‹¯
            </button>
            <div
              x-show="showMenu"
              @click.away="showMenu = false"
              class="absolute right-0 w-24 mt-2 text-white bg-black border border-gray-700 rounded-md shadow-lg"
              style="z-index: 1000"
            >
              <button
                @click="isEditing = true; showMenu = false"
                class="flex items-center w-full px-4 py-2 hover:bg-gray-700"
              >
                ç·¨è¼¯
              </button>
              <button
                @click="deleteComment({{ comment.id }})"
                class="flex items-center w-full px-4 py-2 text-red-500 hover:bg-gray-700"
              >
                åˆªé™¤
              </button>
            </div>
          </div>
          {% endif %}
        </div>
        {% empty %}
        <p class="text-gray-500">é‚„æ²’æœ‰ç•™è¨€ï¼Œæˆç‚ºç¬¬ä¸€å€‹ç•™è¨€çš„äººå§ï¼</p>
        {% endfor %}
      </div>
    </div>

    <!-- è¿”å›æŒ‰éˆ• -->
    <div class="mt-6">
      <a href="{% url 'home:home' %}" class="text-blue-500">â† è¿”å›é¦–é </a>
    </div>
  </div>

  <!-- ç•™è¨€å½ˆçª— -->
  <div
    x-show="commentModal"
    x-cloak
    @close-comment-modal.window="commentModal = false"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
  >
    <div class="p-6 bg-white rounded-lg shadow-lg w-96">
      <h3 class="mb-4 text-lg font-bold">æ’°å¯«ç•™è¨€</h3>
      <form
        id="popupCommentForm"
        method="post"
        action="{% url 'posts:add_comment' post.id %}"
      >
        {% csrf_token %}
        <textarea
          id="popupCommentContent"
          name="content"
          rows="3"
          placeholder="æ’°å¯«ç•™è¨€..."
          class="w-full p-2 border rounded-lg focus:outline-none focus:ring"
          required
        ></textarea>
        <div class="flex justify-end mt-4 space-x-2">
          <button
            type="button"
            @click="commentModal = false"
            class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"
          >
            å–æ¶ˆ
          </button>
          <button
            type="submit"
            class="px-4 py-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600"
          >
            ç™¼ä½ˆç•™è¨€
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // è™•ç†æ„›å¿ƒæŒ‰éˆ•
    function toggleLike(postId) {
      fetch(`/posts/like/${postId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.liked !== undefined) {
            const likeButton = document.querySelector(
              `button[data-post-id="${postId}"]`
            );
            if (likeButton) {
              likeButton.classList.toggle("text-red-500", data.liked);
              likeButton.classList.toggle("text-gray-500", !data.liked);
              likeButton.querySelector("span").textContent = data.like_count;
            }
          }
        })
        .catch((error) => console.error("éŒ¯èª¤:", error));
    }

    // å…¨åŸŸè®Šæ•¸
    window.toggleLike = toggleLike;

    // è™•ç†ç•™è¨€è¡¨å–® (ä¸»ç•™è¨€è¡¨å–®)
    const commentForm = document.getElementById("commentForm");
    const commentContent = document.getElementById("commentContent");
    const commentsList = document.getElementById("commentsList");

    commentForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const content = commentContent.value.trim();
      if (!content) {
        alert("ç•™è¨€å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
        return;
      }

      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;

      fetch(commentForm.action, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ content: content }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            const newComment = document.createElement("div");
            newComment.classList.add("p-4", "bg-gray-100", "rounded-lg");
            newComment.innerHTML = `
              <p class="font-semibold">{{ request.user.username }}</p>
              <p class="text-gray-700">${content}</p>
              <p class="text-sm text-gray-500">å‰›å‰›</p>
            `;
            commentsList.prepend(newComment);
            commentContent.value = "";
            // æ›´æ–°ç•™è¨€æ•¸
            const commentCountSpan = document.querySelector(
              "button > span[x-text='commentCount']"
            );
            if (commentCountSpan) {
              let count = parseInt(commentCountSpan.textContent) + 1;
              commentCountSpan.textContent = count;
            }
          } else {
            alert(data.error || "ç•™è¨€æäº¤å¤±æ•—");
          }
        })
        .catch((error) => {
          console.error("ç•™è¨€éŒ¯èª¤:", error);
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        });
    });
    // è™•ç†ç•™è¨€è¡¨å–® (å½ˆçª—ç•™è¨€è¡¨å–®)
    const popupCommentForm = document.getElementById("popupCommentForm");
    const popupCommentContent = document.getElementById("popupCommentContent");

    popupCommentForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const content = popupCommentContent.value.trim();
      if (!content) {
        alert("ç•™è¨€å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
        return;
      }

      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;

      fetch(popupCommentForm.action, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ content: content }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            const newComment = document.createElement("div");
            newComment.classList.add("p-4", "bg-gray-100", "rounded-lg");
            newComment.innerHTML = `
          <p class="font-semibold">{{ request.user.username }}</p>
          <p class="text-gray-700">${content}</p>
          <p class="text-sm text-gray-500">å‰›å‰›</p>
        `;
            commentsList.prepend(newComment);
            popupCommentContent.value = "";
            // æ›´æ–°ç•™è¨€æ•¸
            const commentCountSpan = document.querySelector(
              "button > span[x-text='commentCount']"
            );
            if (commentCountSpan) {
              let count = parseInt(commentCountSpan.textContent) + 1;
              commentCountSpan.textContent = count;
            }

            // âœ… ä½¿ç”¨ Alpine.js äº‹ä»¶ä¾†é—œé–‰å½ˆçª—
            window.dispatchEvent(new CustomEvent("close-comment-modal"));
          } else {
            alert(data.error || "ç•™è¨€æäº¤å¤±æ•—");
          }
        })
        .catch((error) => {
          console.error("ç•™è¨€éŒ¯èª¤:", error);
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        });
    });
    function updateComment(commentId, newContent) {
      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;
      fetch(`/posts/comments/${commentId}/edit/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ content: newContent }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            location.reload(); // âœ… åˆ·æ–°é é¢é¡¯ç¤ºæ›´æ–°å¾Œçš„ç•™è¨€
          } else {
            alert("æ›´æ–°å¤±æ•—ï¼š" + data.error);
          }
        })
        .catch((error) => console.error("æ›´æ–°ç•™è¨€éŒ¯èª¤:", error));
    }

    // âœ… ç¢ºä¿ `updateComment` å¯ä»¥å¾ HTML å…§éƒ¨ç›´æ¥å‘¼å«
    window.updateComment = updateComment;

    function deleteComment(commentId) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç•™è¨€å—ï¼Ÿ")) return;

      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;
      fetch(`/posts/comments/${commentId}/delete/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            location.reload(); // åˆ·æ–°é é¢ç§»é™¤ç•™è¨€
          } else {
            alert("åˆªé™¤å¤±æ•—ï¼š" + data.error);
          }
        })
        .catch((error) => console.error("åˆªé™¤ç•™è¨€éŒ¯èª¤:", error));
    }
    window.deleteComment = deleteComment;
  });
</script>

{% endblock %}
