{% extends "shared/layout.html" %} {% load static %} {% block content %}

<h1 class="mb-8 text-3xl font-bold text-center text-white">
  歡迎來到 PicTrace！
</h1>

<!-- 最新貼文 -->
<section class="mt-8">
  <h2 class="text-2xl font-bold text-center text-white">最新貼文</h2>

  {% if posts %}
  <div class="flex flex-col mt-6 space-y-6">
    {% for post in posts %}
    <div
      class="relative p-4 bg-white rounded-lg shadow-md"
      x-data="{ openMenu: false }"
      @click.away="openMenu = false"
    >
      <!-- 將點擊區域限制在內容部分，並防止「...」影響點擊 -->
      <a
        href="{% url 'posts:post_detail' post.id %}"
        class="block"
        @click="if(openMenu) $event.preventDefault()"
      >
        <!-- 貼文圖片 -->
        {% if post.image_url %}
        <img
          src="{{ post.image_url }}"
          alt="Post Image"
          class="object-cover w-full rounded-md max-h-[400px]"
        />
        {% endif %}

        <!-- 位置和「...」按鈕 -->
        <div class="flex items-center justify-between">
          {% if post.location %}
          <p class="text-sm text-gray-500">📍 {{ post.location }}</p>
          {% endif %}

          <!-- 三個點的選單按鈕 -->
          {% if user == post.author %}
          <div @click.stop class="relative">
            <!-- ...按鈕 -->
            <button
              @click="openMenu = !openMenu"
              class="p-2 text-gray-500 rounded-full hover:text-gray-700 hover:bg-gray-200"
              title="更多選項"
            >
              ⋯
            </button>

            <!-- 自訂樣式的下拉選單 -->
            <div
              x-show="openMenu"
              @click.away="openMenu = false"
              x-transition
              class="absolute z-10 w-24 mt-2 overflow-hidden text-white bg-black border border-gray-700 rounded-md shadow-lg right-2 ring-1 ring-white ring-opacity-20"
            >
              <!-- 編輯 -->
              <button
                @click.stop.prevent="openEditModal({{ post.id }}, '{{ post.content|escapejs }}', '{{ post.location|escapejs }}'); openMenu = false"
                class="flex items-center w-full px-4 py-2 hover:bg-gray-700"
              >
                <span>編輯</span>
              </button>

              <!-- 置頂 -->
              <a
                href="#"
                class="flex items-center w-full px-4 py-2 hover:bg-gray-700"
              >
                <span>置頂</span>
              </a>

              <!-- 刪除 -->
              <form
                action="{% url 'posts:delete_post' post.id %}"
                method="POST"
                onsubmit="return confirm('確定要刪除此貼文嗎？');"
                class="w-full"
              >
                {% csrf_token %}
                <button
                  type="submit"
                  class="flex items-center w-full px-4 py-2 text-left text-red-500 hover:bg-gray-700"
                >
                  刪除
                </button>
              </form>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- 內容 -->
        <p class="mt-2 text-gray-600">{{ post.content|truncatechars:50 }}</p>
        <p class="text-sm text-gray-500">
          由 {{ post.author.username }} 發布於 {{ post.created_at|timesince }}
          前
        </p>
      </a>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="mt-4 text-center text-gray-500">目前沒有貼文。</p>
  {% endif %}
</section>

{% endblock %}
