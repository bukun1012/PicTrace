{% extends "shared/layout.html" %} {% load static %} {% block content %}
<h1 class="mb-8 text-3xl font-bold text-center text-white">
  æ­¡è¿ä¾†åˆ° PicTraceï¼
</h1>

<!-- æœ€æ–°è²¼æ–‡ -->
<section class="mt-8">
  <h2 class="text-2xl font-bold text-center text-white">æœ€æ–°è²¼æ–‡</h2>
  {% if posts %}
  <div class="flex flex-col mt-6 space-y-6">
    {% for post in posts %}
    <a href="{% url 'posts:post_detail' post.id %}">
    <div class="p-4 bg-white rounded-lg shadow-md">
      {% if post.image_url %}
      <img
        src="{{ post.image_url }}"
        alt="Post Image"
        class="object-cover w-full rounded-md max-h-[400px]"
      />
      {% endif %} {% if post.location %}
      <p class="text-sm text-gray-500">ğŸ“ {{ post.location }}</p>
      {% endif %}
      <p class="text-gray-600">{{ post.content|truncatechars:50 }}</p>
      <p class="text-sm text-gray-500">
        ç”± {{ post.author.username }} ç™¼å¸ƒæ–¼ {{ post.created_at|timesince }} å‰
      </p>

      <!-- ç·¨è¼¯èˆ‡åˆªé™¤æŒ‰éˆ•ï¼šåªæœ‰ç™¼æ–‡è€…èƒ½çœ‹åˆ° -->
      {% if user == post.author %}
      <div class="flex justify-between mt-4">
        <a
          href="{% url 'posts:edit_post' post.id %}"
          class="px-3 py-1 text-sm text-white bg-green-500 rounded hover:bg-green-600"
          >ç·¨è¼¯</a
        >
        <form
          action="{% url 'posts:delete_post' post.id %}"
          method="POST"
          onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡è²¼æ–‡å—ï¼Ÿ');"
        >
          {% csrf_token %}
          <button
            type="submit"
            class="px-3 py-1 text-sm text-white bg-red-500 rounded hover:bg-red-600"
          >
            åˆªé™¤
          </button>
        </form>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="mt-4 text-center text-gray-500">ç›®å‰æ²’æœ‰è²¼æ–‡ã€‚</p>
  {% endif %}
</section>

<!-- Alpine.js å‰ç«¯é‚è¼¯ -->
<script>
  document.addEventListener("alpine:init", () => {
    Alpine.data("postModal", () => ({
      isPostModalOpen: false,
      postTitle: "",
      postContent: "",
      imageFile: null,

      handleFileUpload(event) {
        this.imageFile = event.target.files[0];
      },

      async submitPost() {
        if (!this.postTitle || !this.postContent) {
          alert("æ¨™é¡Œå’Œå…§å®¹ä¸å¯ç‚ºç©ºï¼");
          return;
        }

        let formData = new FormData();
        formData.append("title", this.postTitle);
        formData.append("content", this.postContent);
        if (this.imageFile) {
          formData.append("image", this.imageFile);
        }

        try {
          const response = await fetch("{% url 'posts:create_post' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: formData,
          });

          if (response.ok) {
            location.reload(); // æˆåŠŸå¾Œé‡æ–°æ•´ç†é é¢
          } else {
            alert("ç™¼æ–‡å¤±æ•—ï¼Œè«‹é‡è©¦");
          }
        } catch (error) {
          console.error("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
          alert("ç™¼æ–‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼");
        }
      },
    }));
  });
</script>

{% endblock %}
