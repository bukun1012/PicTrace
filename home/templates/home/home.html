{% extends "shared/layout.html" %} {% load static %} {% block content %}

<h1 class="mb-8 text-3xl font-bold text-center text-white">
  æ­¡è¿ä¾†åˆ° PicTraceï¼
</h1>

<!-- æœ€æ–°è²¼æ–‡ -->
<section class="mt-8" x-data="{ activeCommentPostId: null }">
  <!-- Alpine.js Scope -->
  <h2 class="text-2xl font-bold text-center text-white">æœ€æ–°è²¼æ–‡</h2>

  {% if posts %}
  <div class="flex flex-col mt-6 space-y-6">
    {% for post in posts %}
    <div
      class="relative p-4 bg-white rounded-lg shadow-md"
      x-data="{ openMenu: false, liked: {% if post.id in liked_posts %}true{% else %}false{% endif %}, likeCount: {{ post.like_count }}, commentModal: false }"
      @click.away="openMenu = false"
    >
      <!-- è²¼æ–‡åœ–ç‰‡ -->
      {% if post.image_url %}
      <a href="{% url 'posts:post_detail' post.id %}">
        <img
          src="{{ post.image_url }}"
          alt="Post Image"
          class="object-cover w-full rounded-md max-h-[400px]"
        />
        {% endif %}

        <!-- ä½ç½® -->
        {% if post.location %}
        <p class="mt-2 text-sm text-gray-500">ğŸ“ {{ post.location }}</p>
        {% endif %}

        <!-- è²¼æ–‡å…§å®¹ -->
        <div class="mt-2">
          <p class="text-gray-600">{{ post.content|truncatechars:50 }}</p>
          <p class="text-sm text-gray-500">
            ç”± {{ post.author.username }} ç™¼å¸ƒæ–¼ {{ post.created_at|timesince }}
            å‰
          </p>
        </div>
      </a>
      <!-- â¤ï¸ æ„›å¿ƒæŒ‰éˆ•ã€ğŸ’¬ ç•™è¨€æŒ‰éˆ• å’Œ ã€Œ...ã€é¸å–® -->
      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center space-x-4">
          <!-- â¤ï¸ æ„›å¿ƒ -->
          <button
            @click.stop.prevent="toggleLike({{ post.id }})"
            :class="liked ? 'text-red-500' : 'text-gray-500'"
            class="flex items-center space-x-1 focus:outline-none group"
            data-post-id="{{ post.id }}"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 transition-transform duration-200 group-hover:scale-110"
              :fill="liked ? 'currentColor' : 'none'"
              viewBox="0 0 20 20"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
              />
            </svg>
            <span x-text="likeCount"></span>
          </button>

          <!-- ğŸ’¬ ç•™è¨€ -->
          <button
            @click="activeCommentPostId = {{ post.id }}"
            class="flex items-center space-x-1 text-gray-500 focus:outline-none group"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-6 h-6 transition-transform duration-200 group-hover:scale-110"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 10h8M8 14h4m-6 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12l4-4z"
              />
            </svg>
            <span>{{ post.annotated_comment_count }}</span>
          </button>
        </div>

        <!-- ã€Œ...ã€é¸å–® -->
        {% if user == post.author %}
        <div @click.stop class="relative">
          <button
            @click="openMenu = !openMenu"
            class="p-2 text-gray-500 rounded-full hover:text-gray-700 hover:bg-gray-200"
            title="æ›´å¤šé¸é …"
          >
            â‹¯
          </button>

          <!-- è‡ªè¨‚æ¨£å¼çš„ä¸‹æ‹‰é¸å–® -->
          <div
            x-show="openMenu"
            @click.away="openMenu = false"
            x-transition
            class="absolute right-0 z-10 w-24 mt-2 overflow-hidden text-white bg-black border border-gray-700 rounded-md shadow-lg ring-1 ring-white ring-opacity-20"
          >
            <!-- ç·¨è¼¯ -->
            <button
              @click.stop.prevent="openEditModal({{ post.id }}, '{{ post.content|escapejs }}', '{{ post.location|escapejs }}', '{{ post.image_url|escapejs }}'); openMenu = false"
              class="flex items-center w-full px-4 py-2 hover:bg-gray-700"
            >
              <span>ç·¨è¼¯</span>
            </button>

            <!-- ç½®é ‚ -->
            <a
              href="#"
              class="flex items-center w-full px-4 py-2 hover:bg-gray-700"
            >
              <span>ç½®é ‚</span>
            </a>

            <!-- åˆªé™¤ -->
            <form
              action="{% url 'posts:delete_post' post.id %}"
              method="POST"
              onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²¼æ–‡å—ï¼Ÿ');"
              class="w-full"
            >
              {% csrf_token %}
              <button
                type="submit"
                class="flex items-center w-full px-4 py-2 text-left text-red-500 hover:bg-gray-700"
              >
                åˆªé™¤
              </button>
            </form>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- ğŸ’¬ ç•™è¨€å½ˆçª— -->
      <div
        x-show="activeCommentPostId === {{ post.id }}"
        x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
      >
        <div class="p-6 bg-white rounded-lg shadow-lg w-96">
          <h3 class="mb-4 text-lg font-bold">æ’°å¯«ç•™è¨€</h3>
          <form method="post" action="{% url 'posts:add_comment' post.id %}">
            {% csrf_token %}
            <textarea
              name="content"
              rows="3"
              placeholder="æ’°å¯«ç•™è¨€..."
              class="w-full p-2 border rounded-lg focus:outline-none focus:ring"
              required
            ></textarea>
            <div class="flex justify-end mt-4 space-x-2">
              <button
                type="button"
                @click="activeCommentPostId = null"
                class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"
              >
                å–æ¶ˆ
              </button>
              <button
                type="submit"
                class="px-4 py-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600"
              >
                ç™¼ä½ˆç•™è¨€
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="mt-4 text-center text-gray-500">ç›®å‰æ²’æœ‰è²¼æ–‡ã€‚</p>
  {% endif %}
</section>

<!-- â¤ï¸ æ„›å¿ƒåŠŸèƒ½ -->
<script>
  function toggleLike(postId) {
    fetch(`/posts/like/${postId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.liked !== undefined) {
          const likeButton = document.querySelector(
            `button[data-post-id="${postId}"]`
          );
          if (likeButton) {
            likeButton.classList.toggle("text-red-500", data.liked);
            likeButton.classList.toggle("text-gray-500", !data.liked);
            likeButton.querySelector("span").textContent = data.like_count;
          }
        }
      })
      .catch((error) => console.error("éŒ¯èª¤:", error));
  }
</script>

{% endblock %}
